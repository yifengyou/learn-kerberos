# 白话文举栗子讲故事入门介绍

## 例子一：

选自: <https://www.zhihu.com/question/22177404>


很久很久以前，在Kerberos王国有一个神奇的王，它的名字叫KDC(key distribution center)，国号为秦（域名），**为了更好地管理臣民（Client 用户）、管理营业性场所（文件共享服务器、邮件服务器、打印服务器等资源），要求臣民、营业性场所到王室领取一个账号，账号主要包括用户名/密码**。

有一个臣民叫王老虎，账号名为“王老虎”，密码“xxxxxxxx”, 那么在Kerberos王国里，有几个人知道王老虎的密码？

一个是王老虎本人，另一个就是王，即KDC。还有其他人知道吧？没有了！

有一家提供文件共享的服务场所，名字叫“小美共享文件服务社”，密码是“xxxxxxx”，这个账号的密码，在KDC王国，只有2个人知道，一个是自己，另外一个就是王，KDC。


KDC王颁布以下规定：

（1）臣民去臣民家拜访，需要先到KDC票务中心买票，只有买到了被拜访者家的票（Service Ticket)，才能前往拜访。

（2）臣民前去营业场所消费，同样需要先到KDC购票入场。

（3）营业场所去营业场所消费，一样需要购票入场。



现在王老虎想去“小美文件服务社”坐坐，并浏览一下文件，能直接冲进去吗？不能。

王老虎先到KDC票务中心买票，票务中心说：请问你是哪位？王老虎！

票务中心：请用王老虎的密钥加密“一段认证信息”发给我！王老虎照做！

票务中心知道王老虎的密钥，成功解密王老虎的加密信息，认证成功！

**那么，如何确认王老虎身份，以及票务中心身份？ -- 双向认证**

上文说了，在这个世界上除了KDC知道王老虎的密钥，另外一个就是王老虎本人了。

既然KDC用王老虎的密钥解密成功，那说明加密信息的密钥肯定是王老虎的，间接表明买票的人，肯定是王老虎。

以上只是KDC验证王老虎的过程，问题来了，王老虎如何知道KDC票务中心不是假冒的？

很简单，玄机就在“一段认证信息”里了，这“一段认证信息”里，王老虎想写啥就写啥，王老虎是这样写的：

“知乎到底能走多远？”

由于这段信息是用王老虎的密钥发给KDC的，如果KDC是真的，那么自然可以解密到明文信息，然后把王老虎的“知乎到底能走多远？”返回给王老虎，那么王老虎就知道对方是真的KDC。

双向认证成功，可以避免任何一方是假冒的安全风险。

既然认证成功，那么KDC就为王老虎出票呗。KDC给王老虎2件东西：

(1）用王老虎密钥加密的session key

(2) “小美文件服务社”门票（Service Ticket)

这个门票是用“小美文件服务社”的密钥加密，里面包含 :

A) 和王老虎一样的session key

B) 门票持有人姓名：王老虎

C) 王老虎属于哪个Group

上文1、2 中的 session key 是一样的。

接下来王老虎就直奔小美处了，王老虎敲敲小美的门，小美说：先生请出示您的门票。

王老虎出示2样东西：

（1）门票Ticket

（2）用session key 加密“一段认证信息”，认证信息里写道：“美女，你会说相声不？”

小美用自己的密钥解密ticket，得到上文ABC信息。

小美用解密得到的A = session key ，解密（2），得到明文认证信息：“美女，你会说相声不？”

小美对王老虎说：“美女，你会说相声不？”

王老虎窃喜，看来这个小美不是假冒的，否则不可能知道我加密的认证信息！

至此，双向认证成功，接下来就使用双方都知道的session key 来加密/解密双向的流量，由于session key 只有KDC、王老虎、小美知晓，任何第三方都无法知晓session key，所以无法解密流量。

上文忘记说了，小美的每一个文件都具有权限管理，小美根据上文的C，可以知道王老虎属于哪个group，看看这个group有没有被访问文件的“ read 、write 、modify、full control”权限，并依据特定权限，限制王老虎操作文件的特权。


## 例子二：

作为一名特工，我（Client）今晚奉命独身潜入敌营去干掉敌人首领（访问Server）。

根据作战方案所讨论好的计划，在我行动的时间，敌人首领（Server）会刚好坐在司令部里（TGS），而司令部又在敌方基地（KDC）的重重包围中，也就是说在干掉敌人首领之前，我需要突破三道关卡（三个sub-protocol）。

* 骗过敌方基地外围守卫，让其给我进入敌方司令部的许可（ Client向KDC申请TGT，即Ticket Granting Ticket）
* 骗过敌人司令部警卫队，让其给我与敌方首领会面的许可（ Client通过TGT向TGS申请用于访问Server的Ticket）
* 与敌人首领互相确认身份（ Client最终向为了Server对自己的认证向其提交Ticket）

由于我们的团队之前已经成功干掉了敌方阵营中一个可以接近首领的高级将领张将军，得到了他的名称以及口令，所以我现在将伪装成为这名高级将领，潜入敌营。

月光朗照而星稀，我站在敌人基地前，坚毅而镇定。

第一关：潜入敌方基地

敌方基地旁，许多哨兵在明处暗处徘徊，注意着我每时每刻的举动。我拉低帽檐，沉稳地走到基地的守卫处（ Key Distribution Center，KDC），果不其然被守卫拦住了，被问到：“你是什么人？”

我不慌不忙地回答到：“先前出去执行任务的张将军啊，这么快就翻脸不认人了？我现在要去司令部商讨下一步计划，别磨磨唧唧的！”（Client将自己的ID送给KDC）

我虽然已经准备好了张将军的命令口令，但现在还暂时还用不上。但如果没有口令的话，后面的步骤中将寸步难行。我在基地外围的寒风中静静等着，今晚的月亮真的很美，我感到有点词穷了。

守卫处的人现在正在根据我所提供的名字，在资料库核对我的信息。如果发现资料库没有我的名字，那么我立即就会被认为是假冒的。如果有我的信息，资料库也会有我所对应的口令用于核验的我的身份。这个口令只有我（Client）和基地外围守卫（KDC）知道，用这个口令加密过的东西，也只能用这个口令解密。

找到的我所伪装的张将军的名字后，他们给了我两样东西：

物品A：专用于此次的“进入司令部的凭证”（Client/TGS Session Key，即Client与TGS的会话秘钥，TGS即Ticket-Granting Service），这个凭证将用于加密和解密我与司令部警卫队的消息，基地外围守卫不会保留这个凭证。有了这个凭证我才能进入司令部。这个凭证用我的口令（secret key of the client/user）加密过。

物品B：个人信息套件（Ticket-Granting-Ticket ，即TGT），上面有我的名字和其他信息，以及这张信息表的有效时间，还包括一张与上面一样的进入司令部的凭证。由于我要去的是司令部，于是这张表和凭证就用司令部的口令（ the secret key of the TGS ）加密了。

守卫将东西交给我后，准许我进入了基地。我在临走前，拍了拍守卫的肩膀：“好好干，最近我们基地混进了很多眼线，抓到可是大功一件。”

就这样我顺利潜入了基地内部。

第二关：潜入敌方司令部

敌方基地内部探头密布，巡逻兵不断，若有任何差错，都有送命的危险。我得更加小心行事。

守卫交给我的物品A，用的是我的口令加密的，所以我能轻松解开，然后得到了“进入司令部的凭证”。但物品B，用的是司令部的口令加密的，我不知道司令部的口令，所以现在还无法解开，只是先拿着。

天上的月光仍是那么那么皎洁。 拿出“进入司令部凭证”后，我没多想，向司令部快步走去。我越过铁丝网，绕过路障，受到几次盘问，好在都没有露馅。折腾了好一会儿，我终于来司令部门前，门前的警卫队（TGS）拦住了我，面无表情地说：“请出示证件。”

于是我交给警卫队两样东西：

物品C：物品B附上自己的名字。
物品D：准备好的“身份验证信息”，包括我的名字与时间戳， 用自己刚才拿到的“进入司令部的凭证”加密。
司令部警卫队拿到物品C后，首先用“司令部的口令”解密，得到个人信息套件（TGT），以及专门用于此次会面的“进入司令部凭证”。然后用这个凭证解密物品D，得到我刚才准备的身份验证信息，再与之前得到的个人信息套件比较，判断是否相同。

不出意外，我注意到到警卫队队长紧皱的眉头稍微放松了。看来他已经相信我已经通过基地外围守卫的确认了。他握住我的手，说道：“张将军，久仰久仰。首领正在里面等着你呢。”将我放行，并给我两样东西：

物品E：“参见首领套件”（Client-to-server ticket），包括警卫队准备好的我的个人信息包括名字，以及专门用于此次与首领谈话的“与首领交谈凭证”（Client/Server Session Key）。用首领特殊的口令（ service’s secret key ）加密。
物品F：“与首领交谈凭证”，用“进入司令部凭证加密”。
我拿到这两件物品后，用之前得得到的“进入司令部凭证”解密物品F，拿到“与首领交谈凭证”。而物品E我暂时还无法解开。

我在进入司令部之前，又回头看来一眼夜空。月色真的好美。

第三关：确认敌方首领身份

我进入司令部里，敌方司令部与之前设想的一样，狭小而拥挤，只有敌方首领（Server）正坐在中间，而没有其他人。敌方首领看到我走进来，立马喝到：“张将军，停住！在我们交谈前，还是先互验身份，免得被敌人眼线潜入。”

我告诉自己不要紧张，按照之前模拟过无数次的场景，沉稳地交给敌方首领两样物品：

物品E原封不动
物品G：我提供的一份新的“身份验证信息”，包括我的名字，时间戳，用“与首领交谈凭证”加密。
敌方首领拿到后，先用首领特殊口令解密了物品E，拿到物品E中的由警卫队提供的我的个人信息，以及专门用于此次对话的“与首领交谈凭证”。然后用此凭证解密物品E，得到我所提供的新的“身份验证信息”，发现两者确实符合。

敌方首领点了点头，道：“张将军，保险起见，请你也验证我的信息”。

我笑道：“首领想到真周到”。于是接过敌方首领递来的一样东西：

物品H：从我的新“身份验证信息”拿到的时间戳，用“与首领交谈凭证”加密。
我用自己手上的“与首领交谈凭证”解密物品H，发现时间戳正确。眼前这人确实是敌方首领，否则不会有首领的特殊口令来解密物品E。

验明身份后，敌方首领迎了过来，说道：“张将军，最近任务怎么样？”并想要与我握手，我没有回答，拿出早已准备好的匕首，毫不犹豫地向敌方首领心脏递了过去。

参考

《应用密码学》，Bruce Schnier著
* <https://en.wikipedia.org/wiki/Kerberos_(protocol)>
* <https://blog.csdn.net/wulantian/article/details/42418231>



---
